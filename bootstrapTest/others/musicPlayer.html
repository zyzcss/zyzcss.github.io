<!DOCTYPE html> 
<html>
    <head>
        <title>音乐播放器~</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">     
        <meta charset="utf-8">             
        <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">     
        <meta content="yes" name="apple-mobile-web-app-capable">     
        <meta content="black" name="apple-mobile-web-app-status-bar-style">     
        <meta content="telephone=no" name="format-detection">
        <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
        <link href="./css/music.css" type="text/css" rel="stylesheet" >
    </head>
    <body>
        <div class="songsListInfo"></div>
        <div id="player">
            <div class="player-card">
                <h4>我的音乐播放器</h4>
                <span class="player-toggle" title="更多功能" ontouchstart>
                    <div class="player-toggle-list">
                        <div class="player-list-icon" title="列表"></div>
                        <div class="player-search-icon" title="搜索"></div>
                    </div>
                </span>
                <div class="player-corver">
                    <img src="">
                </div>
                <div class="player-info">
                    <h2 class="player-info-music line-limit-length">加载中</h2>
                    <span class="player-info-singer line-limit-length">加载中</span>
                    <span class="player-info-album line-limit-length">加载中</span>
                </div>
                <div class="player-controls">
                    <div class="player-controls-sound">
                        <div class="player-sound-icon player-sound-icon-mustsound"></div>
                        <div class="player-sound-volume"></div>
                        <div class="player-sound-click"></div>
                        <div class="player-sound-now"></div>
                    </div>
                    <div class="player-controls-pre">
                    </div>
                    <div class="player-controls-pause player-controls-start" >
                    </div>
                    <div class="player-controls-next">
                    </div>
                </div>
                <div class="player-time">
                    <span class="player-start">00:00</span>
                    <span class="player-end">00:00</span>
                    <div class="player-progress">
                        <div class="player-progress-back"></div>
                        <div class="player-progress-now"></div>
                    </div>
                </div>
            </div>
            <div id="player-list">
                <div class="player-list-title">
                    <h3>播放列表</h3>
                    <div class="player-icon-back"></div>
                </div>
                <ul class="player-list-songsList list-scroll">
                </ul>
            </div>
        </div>
        <div id="player-search">
            <div class="player-search-header">
                <div class="player-search-in">
                    <input type="text" id="searchContent" placeholder="请输入歌曲或歌单ID">
                    <button class="player-search-button"></button>
                </div>
                <div class="player-search-select"> 
                    <input type="radio" id="searchBySongId" value="1" name="search" checked>
                    <label for="searchBySongId">
                        歌曲ID
                    </label>
                    <input type="radio" id="searchByListId" value="2" name="search">
                    <label for="searchByListId">
                        歌单ID
                    </label>
                    <input type="radio" id="searchBySongName" value="3" name="search">
                    <label for="searchBySongName">
                        歌曲名(暂不支持)
                    </label>
                </div>
                <div class="player-icon-back"></div>
            </div>
            <div class="player-search-hr"></div>
            <div class="player-search-container ">
                <ul class="player-search-searchList list-scroll">
                </ul>
                <div class="list-load-container list-load-none">
                    <div class="list-load">
                    </div>
                </div>
            </div>
        </div>
        <div class="load">
            <div id="wrap">
                <div id="circle"></div>
                <div id="left"></div>
                <div id="right"></div>
                <div id="arc"></div>
                <p><strong>第一次加载请稍等...</strong></p>
            </div>
        </div>
        <audio id="musicPlayer">
            不支持播放器，请跟换浏览器
        </audio>
        <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
        <script>
            function IsPC() {
                let userAgentInfo = navigator.userAgent;
                let Agents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", 
                "iPod"];    //常用的手机系统版本
                let flag = true;    //建立标志
                for (let v = 0; v < Agents.length; v++) {
                    if (userAgentInfo.indexOf(Agents[v]) > 0) {
                        flag = false;    //如果是手机版本返回false
                        break;
                    }
                }
                return flag;
            }
            jQuery(document).ready(function($) {
                if(!IsPC()){
                    $("<link>").attr({ rel: "stylesheet",type: "text/css",href: "./css/mobie.css"
                    }).appendTo("head");
                }
            });
            let player=new Audio(""),
                control=$(".player-controls"),
                isStop=true,
                isNoSound=false,
                timer=null,
                corverImg=$('.player-corver>img'),
                pause=control.find(".player-controls-pause"),
                isRun=false,
                nowSong=0,
                searchUl=$("#player-search .player-search-searchList");;
            player.preload="auto";
            //暂停开始事件 采用setTimeout完成队列防止多次使用
            let onlyPlayOne=null,
                playerOn=function(){
                    pause.click();
                },
                ikk=[];
                /* isStop=true;
                nowSong=i;
                setSong(i);
                pause.click(); */
            pause.on("click",function(){
                onlyPlayOne=function(){};
                ikk.forEach(function(i){
                    clearTimeout(i);
                })
                if(isStop){
                    $(this).removeClass("player-controls-start")
                    player.play();
                    timer=setInterval(setTimeText,1000);
                    isRun=true;
                }else{
                    $(this).addClass("player-controls-start")
                    player.pause();
                    clearInterval(timer);
                    isRun=false;
                }
                isStop=!isStop;
            });
            //上一首下一首
            control.find(".player-controls-pre").on("click",function(){
                if(!nowSong>0){
                    alert("没有上一首了");
                    return;
                }
                player.load();
                isStop=true;
                onlyPlayOne=playerOn;
                nowSong--;
                setSong(nowSong);
                ikk.push(setTimeout(function(){
                    onlyPlayOne();
                },600));
            });
            control.find(".player-controls-next").on("click",function(){
                if(nowSong>songsList.length-1){
                    alert("没有下一首了");
                    return;
                }
                player.load();
                isStop=true;
                onlyPlayOne=playerOn;
                nowSong++;
                setSong(nowSong);
                ikk.push(setTimeout(function(){
                    onlyPlayOne();
                },600));
                
            });
            //声音事件
            let icon=control.find('.player-sound-icon');
            control.find(".player-controls-sound").on("click",function(e){
                let sound=parseInt(control.find('.player-sound-volume').width());
                if(e.target!=this){
                    if(e.target!=icon[0]){
                        let x=e.offsetX;
                        $(this).find('.player-sound-now').css("width",x+"px");
                        if(x<sound/2){
                            icon.removeClass("player-sound-icon-mustsound");
                            icon.addClass("player-sound-icon-moresound");   
                        }else{
                            icon.addClass("player-sound-icon-mustsound");  
                        }
                        player.volume=x/sound;
                    }else{
                        if(!isNoSound){
                            player.volume=0;
                            $(this).find('.player-sound-now').css("width","0px");
                            icon.removeClass("player-sound-icon-moresound");
                            icon.removeClass("player-sound-icon-mustsound");
                            icon.addClass("player-sound-icon-nosound");   
                        }else{
                            player.volume=1;
                            $(this).find('.player-sound-now').css("width",sound+"px");
                            icon.addClass("player-sound-icon-mustsound");  
                        }
                        isNoSound=!isNoSound;
                    }
                }
            }) 
            //ajax接受歌曲信息
            let songInfo=$(".player-info").children(),
                songCorver=$(".player-corver>img");
            function getSongById(id,isSearch){
                $.ajax({    
                    url: 'http://query.yahooapis.com/v1/public/yql',    
                    dataType: 'jsonp',    
                    data: {    
                        q: `select * from json where url=\"http://music.163.com/api/song/detail/?id=${id}&ids=%5B${id}%5D\"`,    
                        format: "json"    
                    },    
                    success: function (data) {
                        let song=JSON.parse(JSON.stringify(data)).query.results["json"];
                        //console.log(song)
                        if(song.code==200){
                            let info=song.songs;
                            if(isSearch){
                                if(info){
                                    searchList.push(info);
                                    console.log(searchList);
                                    searchLi();
                                }else{
                                    alert("没有查询到相关歌曲");
                                    console.log("没有查询到相关歌曲");
                                }
                                searchLoad.addClass("list-load-none");
                            }else{
                                if(info){
                                    songsList.push(info);
                                }else{
                                    alert("该歌曲付费 暂时不能听");
                                } 
                            }    
                        }else{
                            alert("服务器繁忙 请稍后再试");
                            console.log("服务器繁忙");
                        }
                    },
                    error:function(error){
                        console.log(error);
                        if(isSearch){
                            searchLoad.addClass("list-load-none");
                        }
                        alert("加载失败 请确定歌曲是否存在");
                    }    
                });  
            }
            //getSongById(213737);
            //获得歌单列表
            let songsList=[],
                songsListInfo=$(".songsListInfo");
            function getSongList(id,isSearch){
                $.ajax({    
                    url: 'http://query.yahooapis.com/v1/public/yql',    
                    dataType: 'jsonp',    
                    data: {    
                        q: `select * from json where url=\"http://music.163.com/api/playlist/detail?id=${id}&updateTime=-1\"`,   
                        format: "json"    
                    },    
                    success: function (data) { 
                        let result=JSON.parse(JSON.stringify(data)).query.results["json"];
                        console.log(result)
                        if(result.code==200){
                            if(isSearch){
                                searchList.push(result.result);
                                console.log(searchList)
                                searchLi(true);
                            }else{
                                songsList=result.result.tracks;
                                console.log(songsList);
                                loadSongList(songsList);
                                createLi(songsList);
                            }
                            searchLoad.addClass("list-load-none");
                            localStorage.setItem('songsList', JSON.stringify(songsList));
                        }else{
                            alert("查找失败 请确定输入的歌单是否存在");
                            console.log("查找失败");
                            searchLoad.addClass("list-load-none");
                        }
                    },
                    error:function(error){
                        console.log(error);
                        alert("服务器繁忙 稍后尝试");
                        if(isSearch){
                            searchLoad.addClass("list-load-none");
                        }
                    }
                });
            }
            //设置歌曲信息
            function setSong(num){
                let playerSong=songsList[num];
                if(playerSong){
                    changeInfo(playerSong);
                }else{
                    alert("歌曲出错啦")
                }
            }
            //设置时间
            let time=$(".player-time>.player-end"),
                nowTime=$(".player-time>.player-start"),
                progress=$(".player-time>.player-progress"),
                progressNow=progress.find(".player-progress-now"),
                progressWidth=parseInt(progress.css("width"));
            progress.on("click",function(e){
                player.currentTime=Math.floor(e.offsetX/progressWidth*playTime);
                setTimeText();
                isStop=true;
                pause.click();
            });
            //更改歌曲信息
            let playTime=0;
            //改变信息
            function changeInfo(playerSong){
                songCorver.attr("src",playerSong["album"].picUrl+"?param=200y200");
                songInfo[0].innerText=playerSong.name;
                songInfo[2].innerText=playerSong["album"].name;
                playTime=parseInt(playerSong.lMusic.playTime/1000);
                time.text(getTime(playTime));
                let singers=playerSong["artists"];
                songInfo[1].innerText=getSingerNames(singers);
                player.src=`http://music.163.com/song/media/outer/url?id=${playerSong.id}.mp3`;
            } 
            function getSingerNames(singers){
                let singersName=null;
                if(singers instanceof Array){
                    let arr=[];
                    singers.forEach(function(singer){
                        arr.push(singer.name);
                    });
                    singersName=arr.join("\/");
                }else{
                    singersName=singers.name;
                }
                return singersName;
            }
            //时间字体
            let setTimeText=function(){
                if(player.ended){
                    control.find(".player-controls-next").click();
                }
                nowTime.text(getTime(Math.floor(player.currentTime)));
                progressNow.css("width",(parseInt(player.currentTime)/playTime*100).toFixed(0)+"%");
            }
            //销毁初始化加载动画
            let loadHidden=function(){
                $(".load").animate({
                    opacity:0
                },1000,function(){
                    $(this).css("display","none"); 
                });
                loadHidden=null;
            }
            //第一次加载完成的事件
            let loadSongList=function(songsList){
                setSong(nowSong);
                loadHidden();
                timer=setInterval(setTimeText,1000);
            }
            //getSongById(53658493);
            let ul=$("#player-list>.player-list-songsList");
            //第一次加载初始化
            if(localStorage.getItem("songsList")){
                //getSongList(2029258023);
                songsList=JSON.parse(localStorage.getItem("songsList"));
                loadSongList(songsList);
                createLi(songsList);
            }else{
                console.log("初始化")
                getSongList(2029258023);
            }
            $('body')[0].append(player);
            /* 
                右上角的图标点击          
             */
            let playerToggle=$(".player-toggle"),
                search=$('#player-search');
            (function(){
                playerToggle.find(".player-list-icon").on("click",function(e){
                    $('#player-list').css("left",0);
                    e.stopPropagation();
                });
                playerToggle.find(".player-search-icon").on("click",function(e){
                    search.toggleClass("card-rotate");
                    $('#player').toggleClass("card-rotate");
                    e.stopPropagation();
                });
                $("#player-list>.player-list-title>.player-icon-back").on("click",function(e){
                    $('#player-list').css("left","100%");
                    e.stopPropagation();
                });
                search.find(".player-icon-back").on("click",function(){
                    search.toggleClass("card-rotate");
                    $('#player').toggleClass("card-rotate");
                });
            })()
            //播放列表
            let searchList=[],
                info="",
                searchLoad=$("#player-search>.player-search-container>.list-load-container");
            search.find(".player-search-button").on("click",function(e){
                info=search.find("#searchContent").val().trim();
                if(info==""){
                    alert("请输入内容");
                }else{
                    let depend=search.find('input[name="search"]:checked ').val();
                    searchList=[];
                    searchLoad.removeClass("list-load-none");
                    searchUl.children().remove();
                    switch(depend){
                        case "1":
                            getSongById(info,true);
                            break;
                        case "2":
                            getSongList(info,true);
                            break;
                        case "3":
                            alert("暂不支持");
                            break; 
                    }
                }
                e.stopPropagation();
            });
            ul.on("click",function(e){
                let me=$(e.target);
                let info=me.parent();
                //删除按钮
                if(me.attr("removeMe")){
                    removeLi(me,info);
                    let id=info.attr("songid");
                    for(i in songsList){
                        if(songsList[i].id==id){
                            songsList.splice(i,1);
                            localStorage.setItem('songsList', JSON.stringify(songsList));
                            if(i==nowSong){
                                if(nowSong<songsList.length-1){
                                    nowSong--;
                                    control.find(".player-controls-next").click();
                                }else{
                                    control.find(".player-controls-pre").click();
                                }
                            }
                            return;
                        }
                    }
                    return;
                };
                //播放对应歌曲
                if(info.attr("songid")){
                    let songid=info.attr("songid");
                    for(let i in songsList){
                        if(songsList[i].id==songid){
                            isStop=true;
                            nowSong=i;
                            setSong(i);
                            pause.click();
                            $('#player-list').css("left","100%");
                            return ;
                        }
                    }
                    return ;
                }
                //对应歌手
                if(info.attr("singerid")){
                    alert("暂不支持搜索歌手");
                    console.log("singer");
                    return ;
                }       
            });
            //搜索列表 搜歌名ID
            function searchSong(event,_this){
                let e=$(event.target);
                if(e.attr("add")){
                    let have=false;
                    console.log(songsList);
                    songsList.forEach(function(song){
                        if(song.id==searchList[0].id){
                            console.log("已经有这首歌了");
                            alert("已经有这首歌了");
                            have=true;
                            return;
                        }
                    })
                    if(have)return;
                    songsList.push(searchList[0]);
                    appendLi(searchList[0]);
                    let __this=$(_this);
                    searchAnimate(e,__this);
                    localStorage.setItem('songsList', JSON.stringify(songsList));
                }
            }
            //搜索列表 搜歌单ID
            function searchSongsList(event,_this){
                let e=$(event.target),
                    __this=$(_this);
                if(e.attr("add")){
                    mysongs=searchList[0].tracks;
                    let arr=songsList,
                        obj={},
                        potype;
                    for(let i=0;songsList[i]!=null;i++){
                        potype="a"+songsList[i].id;
                        if(!obj[potype]){
                            obj[potype]=true;
                        }
                    }
                    for(let i=0;mysongs[i]!=null;i++){
                        potype="a"+mysongs[i].id;
                        if(!obj[potype]){
                            obj[potype]=true;
                            arr.push(mysongs[i])
                        }
                    }
                    createLi(arr);
                    arr=null;
                    obj=null;
                    potype=null;
                    searchAnimate(e,__this);
                }else if(e.attr("replace")){
                    songsList=searchList[0].tracks;
                    ul.children().remove();
                    setSong(0);
                    createLi(songsList);
                    searchAnimate(e,__this);
                }
                localStorage.setItem('songsList', JSON.stringify(songsList));
            }
            //搜索列表 动画
            function searchAnimate(e,__this){
                e.animate({aa:"360"},{
                    step:function(now,fx){
                        e.css({"transform":"rotate("+now+"deg)"})
                    },
                    duration:300,
                });
                setTimeout(function(){
                    __this.animate({
                        "left":"-580px",
                    },300,function(){
                        __this.remove();
                    }).queue();
                },300);
            }
            //播放列表删除动画
            function removeLi(me,info){
                me.addClass("player-rotate90");
                setTimeout(function(){
                    info.addClass("list-remove");
                    setTimeout(function(){
                        info.remove();
                    },450)
                },200);
            }
            let corverAnimate=null,corverDeg=0;
            //封面旋转
            function corverRun(){
                if(isRun){
                    if(corverDeg==360)corverDeg=0;
                    corverImg.css("transform","rotate("+(corverDeg++)+"deg)");
                    runtime=corverAnimate;
                }
                corverAnimate=requestAnimationFrame(corverRun);
            }
            corverRun();
            //时间转换
            function getTime(s) {
                let t="";
                if(s > -1){
                    let min = Math.floor(s/60) % 60;
                    let sec = s % 60;
                    if(min < 10){t += "0";}
                    t += min + ":";
                    if(sec < 10){t += "0";}
                    t += sec.toFixed(0);
                }
                return t;
            }
            //初始化播放列表
            function createLi(songsList){
                let str="";
                let id,name,singerName,playTime;
                songsList.forEach(function(song){
                    id=song.id,
                    name=song.name,
                    singerId=song["artists"].id,
                    singerName=getSingerNames(song["artists"]),
                    playTime=getTime(song.lMusic.playTime/1000);
                    str+=`<li songId="${id}"><div class="player-list-song" songId="${id}"><span title="${name}">${name}</span></div>
                    <div class="player-list-singer" singerId="${singerId}"><span title="${singerName}">${singerName}</span></div>
                    <div class="player-list-playtime" songId="${id}" ><span title="${playTime}">${playTime}</span>
                    </div><div removeMe="true" class="player-list-remove"></div></li>`;
                });
                ul.append(str);
            }
            //搜索列表
            function searchLi(isList=false,start=0,end=searchList.length){
                let str="",song=null;
                if(isList){
                    let id,name,trackCount;
                    for(let i=start;i<end;i++){
                        song=searchList[i];
                        id=song.id;
                        name=song.name;
                        trackCount=song.trackCount;
                        console.log(song);
                        str+=`<li onclick="searchSongsList(event,this)" songId="${id}"><div class="player-list-song" songsId="${id}"><span title="${name}">${name}</span></div>
                        <div class="player-list-count"><span title="${trackCount}首歌">${trackCount}首</span></div>
                        <div replace="true" class="player-search-replace"></div><div add="true" class="player-search-add"></div></li>`;
                    }
                }else{
                    let id,name,singerName,playTime;
                    for(let i=start;i<end;i++){
                        console.log("i",i)
                        song=searchList[i];
                        id=song.id,
                        name=song.name,
                        singerId=song["artists"].id,
                        singerName=getSingerNames(song["artists"]),
                        str+=`<li onclick="searchSong(event,this)" songId="${id}"><div class="player-list-song" songId="${id}"><span title="${name}">${name}</span></div>
                        <div class="player-list-singer" singerId="${singerId}"><span title="${singerName}">${singerName}</span></div>
                        <div add="true" class="player-search-add"  style="margin-left:2rem;"></div></li>`;
                    }
                }
                searchUl.append(str);
            }
            //播放列表添加新项
            function appendLi(song){
                let str="";
                let id=song.id,
                    name=song.name,
                    singerId=song["artists"].id,
                    singerName=getSingerNames(song["artists"]),
                    playTime=getTime(song.lMusic.playTime/1000);
                    str+=`<li songId="${id}"><div class="player-list-song" songId="${id}"><span title="${name}">${name}</span></div>
                    <div class="player-list-singer" singerId="${singerId}"><span title="${singerName}">${singerName}</span></div>
                    <div class="player-list-playtime" songId="${id}" ><span title="${playTime}">${playTime}</span>
                    </div><div removeMe="true" class="player-list-remove"></div></li>`;
                    ul.append(str);
            }
            //getSongById(419594013);
        </script>
    </body>
</html>